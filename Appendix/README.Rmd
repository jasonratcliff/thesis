---
title: "Appendix README"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (Sys.getenv("USER") != "jasonratcliff") {
  stop("Adjust local script paths in `digi_find.sh`")
}

library(magrittr)
library(ggplot2)
```

To facilitate formatting appendix files for specimens reviewed, an Rscript
was used to read in a column subset from each sheetname in the
`specimens.xlsx` external data from
[`ThesisPackage`](https://github.com/jasonratcliff/ThesisPackage).
A *.tsv* file is written from entries without appendix completion
(missing values in variable `App.A`). $\LaTeX$ formatting is substituted
for collection and collection number values.

```{r appendixRscript, engine='bash'}
Rscript appendix_script.R
```

```{r missingAppendixes}
missing_appendixes <- purrr::map_dfr(
  .x = list.files(pattern = "*_appendix.tsv"), function(appendix) {
    readr::read_tsv(file = appendix,
                    col_types = paste0(rep("c", times = 10), collapse = "")) %>%
      dplyr::mutate(
        sheetname = gsub(pattern = "_appendix.tsv", replacement = "",
                         x = appendix)
      )
  })

ggplot(data = missing_appendixes) +
  geom_bar(aes(x = sheetname, fill = sheetname)) +
  scale_fill_brewer("Sheetname", type = "qual") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Sheetname", y = "Count")
```

# Images

Herbarium voucher specimens were photographed and cataloged by locality.
The following name convention was used for Digikam files:
    
`<Collector>_<Collection Number>_<Herbarium Code(-Accession Number)>`

Where:

 - **Collector** is a character string of the botanist's last name
 - **Collection Number** is an integer for voucher specimen collection number
 - **Herbarium Code** is a two letter uppercase string denoting 
    + **-Accession Number** is a possible voucher-specific herbarium accession

To identify which specimens have been photographed, `digi_find.R` writes a
*.xlsx* file with 

```{r digiFindRscript, engine='bash'}
Rscript digi_find.R
```

```{r missingImages}
digikam <- readxl::read_excel("digikam.xlsx") %>%
  dplyr::mutate(
    path_check = purrr::map_chr(
      .data$path, function(x) ifelse(is.na(x), "Missing", "Match")) %>%
      factor(., levels = c("Missing", "Match"))
  )

ggplot(data = digikam) +
  geom_bar(aes(x = excel_sheet,
               fill = path_check)) +
  scale_fill_discrete("Matched Filepath") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Excel Sheetname", y = "Count")
  
```

## digiKam Photo Organization

To search  subdirectories, a string passed from the command line is wrapped
in **\*** wildcards to recursively find the expression from subdirectory
file names.  If found, the file name including the relative path from the
respective subdirectory is printed. `digi_find.sh` accepts a single
positional argument passed to the bash `find` utility for printing
relative paths to specimens in the photo subdirectory. Search by: 

- Collector

```{r collector, engine='bash'}
./digi_find.sh "Hayden"
```

- Collection Number

```{r collection, engine='bash'}
./digi_find.sh "11931"
```

- Herbarium Accession

```{r herbarium, engine='bash'}
./digi_find.sh MO-3093900
```

```{r cleanup, echo=FALSE}
list.files(pattern = "*_appendix.tsv") %>%
  fs::file_delete()  # remove unformatted file
```

